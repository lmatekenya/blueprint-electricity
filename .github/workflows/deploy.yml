name: Deploy Electricity API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REMOTE_PATH: /var/www/electricity
  NGINX_SITE: /etc/nginx/sites-available/electricity.conf

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: |
            ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${SSH_PORT:-22}" -H "${SSH_HOST}" >> ~/.ssh/known_hosts

      - name: Ensure remote directory exists
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
          REMOTE_PATH: ${{ env.REMOTE_PATH }}
        run: |
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "sudo mkdir -p '${REMOTE_PATH}' &&
          sudo chown -R ${SSH_USER}:${SSH_USER} '${REMOTE_PATH}'"

      - name: Sync project to remote
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
          REMOTE_PATH: ${{ env.REMOTE_PATH }}
        run: |
          rsync -az --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "var/cache" \
            --exclude "var/log" \
            -e "ssh -p ${SSH_PORT:-22}" \
            ./ "${SSH_USER}@${SSH_HOST}:${REMOTE_PATH}"

      - name: Provision and deploy on remote
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
          REMOTE_PATH: ${{ env.REMOTE_PATH }}
          NGINX_SITE: ${{ env.NGINX_SITE }}
          # App secrets and DB config
          APP_SECRET: ${{ secrets.APP_SECRET }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DEFAULT_URI: ${{ secrets.DEFAULT_URI }}
          # Optional (only if you want this workflow to create the database/user on the server)
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" \
            "REMOTE_PATH='${REMOTE_PATH}' \
             NGINX_SITE='${NGINX_SITE}' \
             APP_SECRET='${APP_SECRET}' \
             DATABASE_URL='${DATABASE_URL}' \
             DEFAULT_URI='${DEFAULT_URI}' \
             DB_NAME='${DB_NAME}' \
             DB_USER='${DB_USER}' \
             DB_PASSWORD='${DB_PASSWORD}' \
             bash -se" <<'EOF'

          set -euo pipefail

          : "${REMOTE_PATH:?REMOTE_PATH not set}"
          : "${NGINX_SITE:?NGINX_SITE not set}"

          cd "${REMOTE_PATH}"

          # Secrets from GitHub (may be empty)
          APP_SECRET="${APP_SECRET:-}"
          DATABASE_URL="${DATABASE_URL:-}"
          DEFAULT_URI="${DEFAULT_URI:-}"
          DB_NAME="${DB_NAME:-}"
          DB_USER="${DB_USER:-}"
          DB_PASSWORD="${DB_PASSWORD:-}"

          # 1) System packages (idempotent)
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            nginx mysql-server acl ca-certificates curl unzip git \
            software-properties-common ufw

          # PHP (use Ondrej PPA if PHP not present)
          if ! command -v php >/dev/null 2>&1; then
            sudo add-apt-repository -y ppa:ondrej/php || true
            sudo apt-get update -y
          fi

          # Install PHP 8.2 and common extensions used by Symfony/API
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            php8.2-fpm php8.2-cli php8.2-common php8.2-mysql php8.2-xml \
            php8.2-curl php8.2-intl php8.2-zip php8.2-mbstring php8.2-opcache

          # 2) Composer (idempotent)
          if ! command -v composer >/dev/null 2>&1; then
            EXPECTED_CHECKSUM="$(curl -s https://composer.github.io/installer.sig)"
            php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
            ACTUAL_CHECKSUM="$(php -r "echo hash_file('sha384', 'composer-setup.php');")"
            if [ "$EXPECTED_CHECKSUM" != "$ACTUAL_CHECKSUM" ]; then
              echo "ERROR: Invalid Composer installer checksum"
              rm -f composer-setup.php
              exit 1
            fi
            sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer
            rm -f composer-setup.php
          fi

          # 3) App directory ownership
          sudo mkdir -p "${REMOTE_PATH}"
          sudo chown -R www-data:www-data "${REMOTE_PATH}"

          cd "${REMOTE_PATH}"

            # 4) Environment configuration (FINAL FIX)
            
            # Ensure directory exists
            sudo mkdir -p "${REMOTE_PATH}"
            sudo chown -R www-data:www-data "${REMOTE_PATH}"
            
            # Create .env
            sudo bash -lc "printf '%s\n' \
            'APP_ENV=prod' \
            'APP_DEBUG=0' \
            > ${REMOTE_PATH}/.env"
            
            # Create .env.local
              sudo tee "${REMOTE_PATH}/.env.local" > /dev/null <<EOF
              APP_ENV=prod
              APP_DEBUG=0
              APP_SECRET='${APP_SECRET}'
              DATABASE_URL='${DATABASE_URL}'
              DEFAULT_URI='${DEFAULT_URI}'
              EOF

            
            # Permissions (NOW paths expand correctly)
            sudo chown www-data:www-data \
              ${REMOTE_PATH}/.env \
              ${REMOTE_PATH}/.env.local
            
            sudo chmod 640 \
              ${REMOTE_PATH}/.env \
              ${REMOTE_PATH}/.env.local



          # 5) PHP dependencies (prod)
          sudo -u www-data composer install \
            --no-dev --prefer-dist --optimize-autoloader --no-progress --no-interaction

          # 6) Use existing DB_USER/DB_PASSWORD for app (skip root creation)
          if [ -n "${DB_NAME}" ] && [ -n "${DB_USER}" ] && [ -n "${DB_PASSWORD}" ]; then
            echo "Using existing MySQL user ${DB_USER} for database ${DB_NAME}."
            sudo -u www-data bash -lc "printf '%s\n' 'APP_ENV=prod' 'APP_DEBUG=0' \"APP_SECRET=${APP_SECRET}\" \"DATABASE_URL=${DATABASE_URL}\" > '${REMOTE_PATH}/.env.local'"
          fi

          # 7) Database migrate
          sudo -u www-data php bin/console doctrine:database:create --if-not-exists --env=prod || true
          sudo -u www-data php bin/console doctrine:migrations:migrate --no-interaction --allow-no-migration --env=prod

          # 8) Build assets/importmap (if present) and warm cache
          sudo -u www-data php bin/console importmap:install --no-interaction --env=prod || true
          sudo -u www-data php bin/console assets:install --symlink --relative public || true
          sudo -u www-data php bin/console cache:clear --env=prod
          sudo -u www-data php bin/console cache:warmup --env=prod

          # 9) Permissions on writable dirs
          sudo setfacl -R -m u:www-data:rwx var || true
          sudo setfacl -dR -m u:www-data:rwx var || true

          # 10) Nginx vhost on port 8086 + PHP-FPM sock discovery
          PHPV="$(php -r 'echo PHP_MAJOR_VERSION.\".\".PHP_MINOR_VERSION;')"
          PHP_SOCK="/run/php/php${PHPV}-fpm.sock"

          # Write the nginx vhost using printf to avoid heredoc issues
          sudo bash -lc "printf '%s\n' \
            'server {' \
            '    listen 8086;' \
            '    server_name _;' \
            '    root ${REMOTE_PATH}/public;' \
            '    index index.php;' \
            '' \
            '    access_log /var/log/nginx/electricity.access.log;' \
            '    error_log  /var/log/nginx/electricity.error.log;' \
            '' \
            '    client_max_body_size 16m;' \
            '' \
            '    location / {' \
            '        try_files \\$uri /index.php\\$is_args\\$args;' \
            '    }' \
            '' \
            '    location ~ \\.php$ {' \
            '        include snippets/fastcgi-php.conf;' \
            '        fastcgi_pass unix:${PHP_SOCK};' \
            '        fastcgi_read_timeout 300;' \
            '        fastcgi_param APP_ENV prod;' \
            '    }' \
            '' \
            '    location ~* \\.(?:ico|png|jpg|jpeg|gif|svg|css|js|woff|woff2|ttf)$ {' \
            '        expires 30d;' \
            '        access_log off;' \
            '        add_header Cache-Control \"public, max-age=2592000\";' \
            '    }' \
            '}' > '${NGINX_SITE}'"

          sudo ln -sf "${NGINX_SITE}" /etc/nginx/sites-enabled/electricity.conf
          sudo nginx -t
          sudo systemctl enable --now nginx
          sudo systemctl restart nginx

          # Enable & restart PHP-FPM
          PHPFPM="php${PHPV}-fpm"
          sudo systemctl enable --now "${PHPFPM}"
          sudo systemctl restart "${PHPFPM}"

          # 11) Open firewall port 8086 (if UFW enabled)
          sudo ufw allow 8086/tcp || true

          echo "Deployment completed. App should be reachable on port 8086."
          EOF
